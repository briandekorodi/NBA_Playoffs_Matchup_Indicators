---
title: "Project"
author: "Brian de Korodi"
date: "2024-12-17"
output: pdf_document
---

```{r, message=FALSE, warning=FALSE}
rm(list = ls())
```

### Packages

```{r, message=FALSE, warning=FALSE}
#install.packages("stringr")
#install.packages("dplyr")
#install.packages("httr")
#install.packages("rvest")
#install.packages("ggplot2")
#install.packages("tidyr")
#install.packages("tidyverse")
#install.packages("caret")
#install.packages("randomForest")
library(stringr)
library(dplyr)
library(httr)
library(rvest)
library(ggplot2)
library(tidyr)
library(tidyverse)
library(purrr)
library(caret)
library(randomForest)
```

### Path names for data extraction

```{r}
Seasons_folder <- "/Users/bdekorodi/Desktop/Project/Project_data/Seasons"
Playoffs_folder <- "/Users/bdekorodi/Desktop/Project/Project_data/Playoffs"
```

### Extracting data

Loops used to perform the same table extractions from the raw html code for each year.

The columns are renamed.

The team names are changed so that all seasons contain the same team names. For example, the Seattle Super Sonics changed owners in 2009 and the team was moved to Oklahoma, becoming the Oklahoma City Thunder. In the data, the name Seattle Super Sonics is changed to Oklahoma City Thunder for all years. Team names have no causality towards results so these operations simply homogenize the names and allow for successful joining of the data sets later on.

The types of the columns are changed.

A list of data frames is created for each extraction, containing the data sets for all the teams in each year.

#### Seasons - Team per 100 possessions

```{r, message=FALSE, warning=FALSE}
Seasons_Team_per100poss <- list()
for (year in 1997:2024) {
  Seasons_file <- file.path(Seasons_folder, paste0("Season_", year, ".html"))
  tryCatch({
    Seasons_Team_per100poss[[paste0("team_per100poss_", year)]] <- read_html(Seasons_file) %>%
      html_nodes(xpath = '//*[@id="per_poss-team"]') %>%
      html_table(header=TRUE) %>%
      .[[1]] %>%
      mutate(Year = year)
  })
}
col_names_Team_per100poss <- c("Team", "Games_Played", "Minutes_Played", "FGMr", "FGAr", "FG%","3PMr", "3PAr", "3P%", "2PMr", "2PAr", "2P%", "FTMr", "FTAr", "FT%", "ORBr", "DRBr", "TRBr","ASTr", "STLr", "BLKr", "TOVr", "PFr", "ORtg", "Year")
Seasons_Team_per100poss <- lapply(Seasons_Team_per100poss, function(df) {
  df <- df[, -1, drop = FALSE]
  colnames(df) <- col_names_Team_per100poss[seq_len(ncol(df))]
    if ("Team" %in% colnames(df)) {
    df$Team <- str_remove(df$Team, "\\*$")
    df$Team <- str_replace_all(df$Team, c(
      "New Jersey Nets" = "Brooklyn Nets",
      "Seattle SuperSonics" = "Oklahoma City Thunder",
      "Vancouver Grizzlies" = "Memphis Grizzlies",
      "Washington Bullets" = "Washington Wizards",
      "New Orleans Hornets" = "New Orleans Pelicans",
      "New Orleans/Oklahoma City Hornets" = "New Orleans Pelicans",
      "Charlotte Bobcats" = "Charlotte Hornets"
    ))
    df <- df %>%
    mutate(
      Team = as.character(Team),
      Year = as.integer(Year),
      across(.cols = -c(Team, Year), .fns = as.numeric)
      )
  }
  return(df)
  
})
team_per100poss_rm_row_21 <- c("team_per100poss_2005", "team_per100poss_2006", "team_per100poss_2007", "team_per100poss_2008", "team_per100poss_2009", "team_per100poss_2010", "team_per100poss_2011", "team_per100poss_2012", "team_per100poss_2013", "team_per100poss_2014", "team_per100poss_2015", "team_per100poss_2016", "team_per100poss_2017", "team_per100poss_2018", "team_per100poss_2019", "team_per100poss_2020", "team_per100poss_2021", "team_per100poss_2022", "team_per100poss_2023", "team_per100poss_2024")

for (name in team_per100poss_rm_row_21) {
  Seasons_Team_per100poss[[name]] <- Seasons_Team_per100poss[[name]][-c(21), ]
}
```

#### Seasons - Opponent per 100 possessions

```{r, message=FALSE, warning=FALSE}
Seasons_Opp_per100poss <- list()
for (year in 1997:2024) {
  Seasons_file <- file.path(Seasons_folder, paste0("Season_", year, ".html"))
  tryCatch({
    Seasons_Opp_per100poss[[paste0("opp_per100poss_", year)]] <- read_html(Seasons_file) %>%
      html_nodes(xpath = '//*[@id="per_poss-opponent"]') %>%
      html_table(header=TRUE) %>%
      .[[1]] %>%
      mutate(Year = year)
  })
}
col_names_Opp_per100poss <- c("Team", "Games_Played", "Minutes_Played", "oppFGMr", "oppFGAr", "oppFG%","opp3PMr", "opp3PAr", "opp3P%", "opp2PMr", "opp2PAr", "opp2P%", "oppFTMr", "oppFTAr", "oppFT%", "oppORBr", "oppDRBr", "oppTRBr","oppASTr", "oppSTLr", "oppBLKr", "oppTOVr", "oppPFr", "DRtg", "Year")
Seasons_Opp_per100poss <- lapply(Seasons_Opp_per100poss, function(df) {
  df <- df[, -1, drop = FALSE]
  colnames(df) <- col_names_Opp_per100poss[seq_len(ncol(df))]
    if ("Team" %in% colnames(df)) {
    df$Team <- str_remove(df$Team, "\\*$")
    df$Team <- str_replace_all(df$Team, c(
      "New Jersey Nets" = "Brooklyn Nets",
      "Seattle SuperSonics" = "Oklahoma City Thunder",
      "Vancouver Grizzlies" = "Memphis Grizzlies",
      "Washington Bullets" = "Washington Wizards",
      "New Orleans Hornets" = "New Orleans Pelicans",
      "New Orleans/Oklahoma City Hornets" = "New Orleans Pelicans",
      "Charlotte Bobcats" = "Charlotte Hornets"
    ))
    df <- df %>%
    mutate(
      Team = as.character(Team),
      Year = as.integer(Year),
      across(.cols = -c(Team, Year), .fns = as.numeric)
      )
  }
  return(df)
})
```

#### Seasons - Team advanced

```{r, message=FALSE, warning=FALSE}
Seasons_Team_advanced <- list()

for (year in 1997:2024) {
  Seasons_file <- file.path(Seasons_folder, paste0("Season_", year, ".html"))
  
  tryCatch({
    Seasons_Team_advanced[[paste0("team_advanced_", year)]] <- read_html(Seasons_file) %>%
      html_nodes(xpath = '//*[@id="advanced-team"]') %>%
      html_table(fill = TRUE) %>%
      .[[1]]
    col_names <- Seasons_Team_advanced[[paste0("team_advanced_", year)]][1, ]
    Seasons_Team_advanced[[paste0("team_advanced_", year)]] <- Seasons_Team_advanced[[paste0("team_advanced_", year)]][-1, ]
    col_names <- ifelse(is.na(col_names) | col_names == "", 
                        paste0("Col", seq_along(col_names)), 
                        col_names)
    colnames(Seasons_Team_advanced[[paste0("team_advanced_", year)]]) <- col_names
  })
}

col_names_Team_advanced <- c("Rank", "Team", "Average_age", "Wins", "Losses", "Expected_wins", "Expected_Losses", "MOV", "SOS", "SRS", "ORtg", "DRtg", "NRtg", "Pace", "FTA_per_FGA", "%3PA", "TS%", "Col18", "eFG%", "TOV%","ORB%", "FT_per_FGA", "Col23", "oppeFG%", "oppTOV%", "DRB%", "oppFT_per_FGA", "Col28", "Arena", "Attendance", "Attendance_per_Game")
Seasons_Team_advanced <- lapply(Seasons_Team_advanced, function(df) {
  colnames(df) <- col_names_Team_advanced[seq_len(ncol(df))]
    if ("Team" %in% colnames(df)) {
    df$Team <- str_remove(df$Team, "\\*$")
    df$Team <- str_replace_all(df$Team, c(
      "New Jersey Nets" = "Brooklyn Nets",
      "Seattle SuperSonics" = "Oklahoma City Thunder",
      "Vancouver Grizzlies" = "Memphis Grizzlies",
      "Washington Bullets" = "Washington Wizards",
      "New Orleans Hornets" = "New Orleans Pelicans",
      "New Orleans/Oklahoma City Hornets" = "New Orleans Pelicans",
      "Charlotte Bobcats" = "Charlotte Hornets"
    ))
    }
  df <- df %>%
      select(-c(Col18, Col23, Col28, Rank))
    df <- df %>%
  mutate(
    Attendance = as.numeric(gsub(",", "", Attendance)),
    Attendance_per_Game = as.numeric(gsub(",", "", Attendance_per_Game))
  )
  df <- df %>%
    mutate(
      Team = as.character(Team),
      Arena = as.character(Arena),
      across(.cols = -c(Team, Arena), .fns = as.numeric)
      )
  return(df)
})

team_advanced_rm_row_16_17 <- c("team_advanced_2005", "team_advanced_2006", "team_advanced_2007", "team_advanced_2008", "team_advanced_2009", "team_advanced_2010", "team_advanced_2011", "team_advanced_2012", "team_advanced_2013", "team_advanced_2014", "team_advanced_2015", "team_advanced_2016", "team_advanced_2017", "team_advanced_2018", "team_advanced_2019", "team_advanced_2020", "team_advanced_2021", "team_advanced_2022", "team_advanced_2023", "team_advanced_2024")

for (name in team_advanced_rm_row_16_17) {
  Seasons_Team_advanced[[name]] <- Seasons_Team_advanced[[name]][-c(16, 17), ]
}
```

#### Seasons - Team shooting

Basketball reference added Layup %FGA and total made layups to shooting data starting the 01-02 season, so we must create two separate loops so that columns are not shifted sideways.

```{r, message=FALSE, warning=FALSE}

Seasons_Team_shooting_pre_2002 <- list()
Seasons_Team_shooting_post_2002 <- list()

col_names_Team_shooting_pre_2002 <- c("Rank", "Team", "Games_Played", "Minutes_Played", "FG%", "Average_FGA_distance", "Col7", "2P%FGA", "0_3%FGA", "3_10%FGA", "10_16%FGA", "16_3P%FGA", "3P%FGA", "Col14", "2P%", "0_3FG%", "3_10FG%", "10_16FG%","16_3PFG%", "3P%", "Col21", "2P%FGAst", "3P%FGAst", "Col24", "Dunks%FGA", "Made_dunks", "Col27", "Corner%3PA", "Corner3P%", "Col30", "Attempted_heaves", "Made_heaves")

col_names_Team_shooting_post_2002 <- c("Rank", "Team", "Games_Played", "Minutes_Played", "FG%", "Average_FGA_distance", "Col7", "2P%FGA", "0_3%FGA", "3_10%FGA", "10_16%FGA", "16_3P%FGA", "3P%FGA", "Col14", "2P%", "0_3FG%", "3_10FG%", "10_16FG%", "16_3PFG%", "3P%", "Col21", "2P%FGAst", "3P%FGAst", "Col24", "Dunks%FGA", "Made_dunks", "Col27", "Layups%FGA", "Made_Layups", "Col33", "Corner%3PA", "Corner3P%", "Col30", "Attempted_heaves", "Made_heaves")

for (year in 1997:2001) {
  Seasons_file <- file.path(Seasons_folder, paste0("Season_", year, ".html"))
  
  tryCatch({
    df <- read_html(Seasons_file) %>%
      html_nodes(xpath = '//*[@id="shooting-team"]') %>%
      html_table(fill = TRUE) %>%
      .[[1]]
    col_names <- df[1, ]
    df <- df[-1, ]
    col_names <- ifelse(is.na(col_names) | col_names == "", 
                        paste0("Col", seq_along(col_names)), 
                        col_names)
    colnames(df) <- col_names
    colnames(df) <- col_names_Team_shooting_pre_2002[seq_len(ncol(df))]
    Seasons_Team_shooting_pre_2002[[paste0("team_shooting_", year)]] <- df
  }, error = function(e) {
    message(paste("Error processing year:", year))
  })
}

for (year in 2002:2024) {
  Seasons_file <- file.path(Seasons_folder, paste0("Season_", year, ".html"))
  
  tryCatch({
    df <- read_html(Seasons_file) %>%
      html_nodes(xpath = '//*[@id="shooting-team"]') %>%
      html_table(fill = TRUE) %>%
      .[[1]]
    col_names <- df[1, ]
    df <- df[-1, ]
    col_names <- ifelse(is.na(col_names) | col_names == "", 
                        paste0("Col", seq_along(col_names)), 
                        col_names)
    colnames(df) <- col_names
    colnames(df) <- col_names_Team_shooting_post_2002[seq_len(ncol(df))]
    df <- df[, !colnames(df) %in% c("Layups%FGA", "Made_Layups", "Col33")]
    Seasons_Team_shooting_post_2002[[paste0("team_shooting_", year)]] <- df
  })
}

Seasons_Team_shooting <- c(Seasons_Team_shooting_pre_2002, Seasons_Team_shooting_post_2002)

names(Seasons_Team_shooting) <- paste0("team_shooting_", 1997:2024)

Seasons_Team_shooting <- lapply(Seasons_Team_shooting, function(df) {
    df$Team <- str_remove(df$Team, "\\*$")
    df$Team <- str_replace_all(df$Team, c(
      "New Jersey Nets" = "Brooklyn Nets",
      "Seattle SuperSonics" = "Oklahoma City Thunder",
      "Vancouver Grizzlies" = "Memphis Grizzlies",
      "Washington Bullets" = "Washington Wizards",
      "New Orleans Hornets" = "New Orleans Pelicans",
      "New Orleans/Oklahoma City Hornets" = "New Orleans Pelicans",
      "Charlotte Bobcats" = "Charlotte Hornets"
    ))
    df <- df[, !colnames(df) %in% c("Rank", "Col7", "Col14", "Col21", "Col24", "Col27", "Col30")]
    df <- df %>%
    mutate(
      Team = as.character(Team),
      across(.cols = -Team, .fns = as.numeric)
    )
  return(df)
})
team_shooting_rm_row_16_17 <- c("team_shooting_2005", "team_shooting_2006", "team_shooting_2007", "team_shooting_2008", "team_shooting_2009", "team_shooting_2010", "team_shooting_2011", "team_shooting_2012", "team_shooting_2013", "team_shooting_2014", "team_shooting_2015", "team_shooting_2016", "team_shooting_2017", "team_shooting_2018", "team_shooting_2019", "team_shooting_2020", "team_shooting_2021", "team_shooting_2022", "team_shooting_2023", "team_shooting_2024")

for (name in team_shooting_rm_row_16_17) {
  Seasons_Team_shooting[[name]] <- Seasons_Team_shooting[[name]][-c(16, 17), ]
}

rm(Seasons_Team_shooting_post_2002, Seasons_Team_shooting_pre_2002, df, col_names)
```

#### Seasons - Opponent shooting

```{r, message=FALSE, warning=FALSE}

Seasons_Opp_shooting_pre_2002 <- list()
Seasons_Opp_shooting_post_2002 <- list()

col_names_Opp_shooting_pre_2002 <- c("Rank", "Team", "Games_Played", "Minutes_Played", "oppFG%", "oppAverage_FGA_distance", "Col7", "opp2P%FGA", "opp0_3%FGA", "opp3_10%FGA", "opp10_16%FGA", "opp16_3P%FGA", "opp3P%FGA", "Col14", "opp2P%","opp0_3FG%", "opp3_10FG%", "opp10_16FG%", "opp16_3PFG%", "opp3P%", "Col21", "opp2P%FGAst","opp3P%FGAst", "Col24", "oppDunks%FGA", "oppMade_dunks", "Col27", "oppCorner%3PA", "oppCorner3P%")

col_names_Opp_shooting_post_2002 <- c("Rank", "Team", "Games_Played", "Minutes_Played", "oppFG%", "oppAverage_FGA_distance", "Col7", "opp2P%FGA", "opp0_3%FGA", "opp3_10%FGA", "opp10_16%FGA", "opp16_3P%FGA", "opp3P%FGA", "Col14", "opp2P%","opp0_3FG%", "opp3_10FG%", "opp10_16FG%", "opp16_3PFG%", "opp3P%", "Col21", "opp2P%FGAst","opp3P%FGAst", "Col24", "oppDunks%FGA", "oppMade_dunks", "Col27", "oppLayups%FGA", "oppMade_Layups", "Col30", "oppCorner%3PA", "oppCorner3P%")

for (year in 1997:2001) {
  Seasons_file <- file.path(Seasons_folder, paste0("Season_", year, ".html"))
  
  tryCatch({
    df <- read_html(Seasons_file) %>%
      html_nodes(xpath = '//*[@id="shooting-opponent"]') %>%
      html_table(fill = TRUE) %>%
      .[[1]]
    col_names <- df[1, ]
    df <- df[-1, ]
    col_names <- ifelse(is.na(col_names) | col_names == "", 
                        paste0("Col", seq_along(col_names)), 
                        col_names)
    colnames(df) <- col_names
    colnames(df) <- col_names_Opp_shooting_pre_2002[seq_len(ncol(df))]
    Seasons_Opp_shooting_pre_2002[[paste0("opp_shooting_", year)]] <- df
  })
}

for (year in 2002:2024) {
  Seasons_file <- file.path(Seasons_folder, paste0("Season_", year, ".html"))
  
  tryCatch({
    df <- read_html(Seasons_file) %>%
      html_nodes(xpath = '//*[@id="shooting-opponent"]') %>%
      html_table(fill = TRUE) %>%
      .[[1]]
    col_names <- df[1, ]
    df <- df[-1, ]
    col_names <- ifelse(is.na(col_names) | col_names == "", 
                        paste0("Col", seq_along(col_names)), 
                        col_names)
    colnames(df) <- col_names
    colnames(df) <- col_names_Opp_shooting_post_2002[seq_len(ncol(df))]
    df <- df[, !colnames(df) %in% c("oppLayups%FGA", "oppMade_Layups", "Col30", "Col33")]
    Seasons_Opp_shooting_post_2002[[paste0("opp_shooting_", year)]] <- df
  })
}

Seasons_Opp_shooting <- c(Seasons_Opp_shooting_pre_2002, Seasons_Opp_shooting_post_2002)

names(Seasons_Opp_shooting) <- paste0("opp_shooting_", 1997:2024)

Seasons_Opp_shooting <- lapply(Seasons_Opp_shooting, function(df) {
    df$Team <- str_remove(df$Team, "\\*$")
    df$Team <- str_replace_all(df$Team, c(
      "New Jersey Nets" = "Brooklyn Nets",
      "Seattle SuperSonics" = "Oklahoma City Thunder",
      "Vancouver Grizzlies" = "Memphis Grizzlies",
      "Washington Bullets" = "Washington Wizards",
      "New Orleans Hornets" = "New Orleans Pelicans",
      "New Orleans/Oklahoma City Hornets" = "New Orleans Pelicans",
      "Charlotte Bobcats" = "Charlotte Hornets"
    ))
    df <- df[, !colnames(df) %in% c("Rank", "Col7", "Col14", "Col21", "Col24", "Col27")]
    df <- df %>%
    mutate(
      Team = as.character(Team),
      across(.cols = -Team, .fns = as.numeric)
    )
return(df)
})

rm(Seasons_Opp_shooting_post_2002, Seasons_Opp_shooting_pre_2002, df, col_names)
```

#### Joining the data sets from each season by team name

```{r, message=FALSE, warning=FALSE}
clean_column_names <- function(lst) {
  lapply(lst, function(df) {
    colnames(df) <- make.names(colnames(df), unique = TRUE)
    return(df)
  })
}
Seasons_Team_per100poss <- clean_column_names(Seasons_Team_per100poss)
Seasons_Opp_per100poss <- clean_column_names(Seasons_Opp_per100poss)
Seasons_Team_advanced <- clean_column_names(Seasons_Team_advanced)
Seasons_Team_shooting <- clean_column_names(Seasons_Team_shooting)
Seasons_Opp_shooting <- clean_column_names(Seasons_Opp_shooting)

all_team_names <- unique(unlist(lapply(Seasons_Team_per100poss, function(df) df$Team)))

Seasons <- list()

for (year in 1997:2024) {
  Seasons[[paste0("Season_", year)]] <- Seasons_Team_per100poss[[paste0("team_per100poss_", year)]] %>%
    full_join(Seasons_Opp_per100poss[[paste0("opp_per100poss_", year)]], by = "Team") %>%
    full_join(Seasons_Team_advanced[[paste0("team_advanced_", year)]], by = "Team") %>%
    full_join(Seasons_Team_shooting[[paste0("team_shooting_", year)]], by = "Team") %>%
    full_join(Seasons_Opp_shooting[[paste0("opp_shooting_", year)]], by = "Team")%>%
    rename_with(~ gsub("X", "", .)) %>%
    rename("Games_Played" = "Games_Played.x",
           "Minutes_Played" = "Minutes_Played.x",
           "FG%" = "FG..x",
           "2P%" = "2P..x",
           "3P%" = "3P..x",
           "FT%" = "FT.",
           "ORtg" = "ORtg.x",
           "Year" = "Year.x",
           "oppFG%" = "oppFG..x",
           "opp2P%" = "opp2P..x",
           "opp3P%" = "opp3P..x",
           "oppFT%" = "oppFT.",
           "DRB%" = "DRB.",
           "DRtg" = "DRtg.x",
           "%3PA" = ".3PA",
           "TS%" = "TS.",
           "eFG%" = "eFG.",
           "TOV%" = "TOV.",
           "ORB%" = "ORB.",
           "oppeFG%" = "oppeFG.",
           "oppTOV%" = "oppTOV.",
           "2P%FGA" = "2P.FGA",
           "0_3%FGA" = "0_3.FGA",
           "3_10%FGA" = "3_10.FGA",
           "10_16%FGA" = "10_16.FGA",
           "16_3P%FGA" = "16_3P.FGA",
           "3P%FGA" = "3P.FGA",
           "0_3FG%" = "0_3FG.",
           "3_10FG%" = "3_10FG.",
           "10_16FG%" = "10_16FG.",
           "16_3PFG%" = "16_3PFG.",
           "2P%FGAst" = "2P.FGAst",
           "3P%FGAst" = "3P.FGAst",
           "Dunks%FGA" = "Dunks.FGA",
           "Corner%3PA" = "Corner.3PA",
           "Corner3P%" = "Corner3P.",
           "opp2P%FGA" = "opp2P.FGA",
           "opp0_3%FGA" = "opp0_3.FGA",
           "opp3_10%FGA" = "opp3_10.FGA",
           "opp10_16%FGA" = "opp10_16.FGA",
           "opp16_3P%FGA" = "opp16_3P.FGA",
           "opp3P%FGA" = "opp3P.FGA",
           "opp0_3FG%" = "opp0_3FG.",
           "opp3_10FG%" = "opp3_10FG.",
           "opp10_16FG%" = "opp10_16FG.",
           "opp16_3PFG%" = "opp16_3PFG.",
           "opp2P%FGAst" = "opp2P.FGAst",
           "opp3P%FGAst" = "opp3P.FGAst",
           "oppDunks%FGA" = "oppDunks.FGA",
           "oppCorner%3PA" = "oppCorner.3PA",
           "oppCorner3P%" = "oppCorner3P.") %>%
    select(-contains("Games_Played.y"), 
           -contains("Minutes_Played.y"),
           -contains("Year.y"), 
           -contains("Rank.x"),
           -contains("ORtg.y"), 
           -contains("DRtg.y"),
           -contains("Games_Played.x.x"), 
           -contains("Minutes_Played.x.x"),
           -contains("FG..y"), 
           -contains("2P..y"), 
           -contains("3P..y"),
           -contains("Games_Played.y.y"), 
           -contains("Minutes_Played.y.y"), 
           -contains("oppFG..y")) %>%
    mutate(Attendance = gsub(",", "", Attendance),
           Attendance_per_Game = gsub(",", "", Attendance_per_Game)) %>%
    mutate(across(.cols = -c(Arena, Team), .fns = as.numeric)) %>%
    right_join(data.frame(Team = all_team_names), by = "Team")
}
```

#### Playoffs Series - Four Factors

```{r, message=FALSE, warning=FALSE}
Playoffs_FourFactors <- list()
Playoffs_Advanced <- list()
Playoff_series <- c("Finals", "ECF", "WCF", 
                    "ECR2_1", "ECR2_2", "WCR2_1", "WCR2_2", 
                    "ECR1_1", "ECR1_2", "ECR1_3", "ECR1_4", 
                    "WCR1_1", "WCR1_2", "WCR1_3", "WCR1_4")

for (year in 1997:2024) {
  Playoffs_year_folder <- file.path(Playoffs_folder, as.character(year))
  
  for (file in Playoff_series) {
    Playoffs_file <- file.path(Playoffs_year_folder, paste0(file, "_", year, ".html"))
    
    tryCatch({
      raw_html <- readLines(Playoffs_file, warn = FALSE) %>%
        paste(collapse = "\n") %>%
        str_remove_all("<!--|-->")
      
      Playoffs_FourFactors[[paste0(file, "_", year)]] <- read_html(raw_html) %>%
        html_nodes(xpath = '//*[@id="four_factors"]') %>%
        html_table(fill = TRUE) %>%
        .[[1]]
      
      advanced_tables <- read_html(raw_html) %>%
        html_nodes(xpath = '//div[contains(@id, "advanced_sh")]/following-sibling::div') %>%
        html_nodes("table") %>%
        html_table(fill = TRUE)
      
      # Loop through the advanced tables and store them in the list
      for (i in seq_along(advanced_tables)) {
        table_name <- paste0(file, "_", year, "_Advanced_", i)
        Playoffs_Advanced[[table_name]] <- advanced_tables[[i]]
      }
    }, error = function(e) {})
  }
}

Playoffs_Advanced[["Finals_2024_Advanced_2"]] <- NULL
Playoffs_Advanced[["Finals_2024_Advanced_4"]] <- NULL
Playoffs_Advanced[["Finals_2023_Advanced_2"]] <- NULL
Playoffs_Advanced[["Finals_2023_Advanced_4"]] <- NULL


team_name_mapping <- c(
  "CHI" = "Chicago Bulls",
  "BOS" = "Boston Celtics",
  "LAL" = "Los Angeles Lakers",
  "MIA" = "Miami Heat",
  "GSW" = "Golden State Warriors",
  "CLE" = "Cleveland Cavaliers",
  "SA" = "San Antonio Spurs",
  "TOR" = "Toronto Raptors",
  "NYK" = "New York Knicks",
  "OKC" = "Oklahoma City Thunder",
  "MIL" = "Milwaukee Bucks",
  "HOU" = "Houston Rockets",
  "PHI" = "Philadelphia 76ers",
  "SAS" = "San Antonio Spurs",
  "MIN" = "Minnesota Timberwolves",
  "DET" = "Detroit Pistons",
  "IND" = "Indiana Pacers",
  "PHX" = "Phoenix Suns",
  "PHO" = "Phoenix Suns",
  "ORL" = "Orlando Magic",
  "DAL" = "Dallas Mavericks",
  "POR" = "Portland Trail Blazers",
  "SAC" = "Sacramento Kings",
  "WAS" = "Washington Wizards",
  "DEN" = "Denver Nuggets",
  "UTA" = "Utah Jazz",
  "CHA" = "Charlotte Hornets",
  "CHH" = "Charlotte Hornets",
  "CHO" = "Charlotte Hornets",
  "ATL" = "Atlanta Hawks",
  "LAC" = "Los Angeles Clippers",
  "MEM" = "Memphis Grizzlies",
  "NJN" = "Brooklyn Nets",
  "BRK" = "Brooklyn Nets",
  "SEA" = "Oklahoma City Thunder",
  "VAN" = "Memphis Grizzlies",
  "WSB" = "Washington Wizards",
  "NOH" = "New Orleans Pelicans",
  "NOP" = "New Orleans Pelicans")

Playoffs_FourFactors <- lapply(names(Playoffs_FourFactors), function(name) {
  df <- Playoffs_FourFactors[[name]]
      colnames(df)[1] <- "Result"
      colnames(df)[2] <- "Series_Pace"
      colnames(df)[3] <- "Series_eFGpct"
      colnames(df)[4] <- "Series_TOVpct"
      colnames(df)[5] <- "Series_ORBpct"
      colnames(df)[6] <- "Series_FTperFGA"
      colnames(df)[7] <- "Series_ORtg"
      colnames(df)[8] <- "Series_PTSperG"
      df <- df[-1, ]
      df$`Series_Games` <- str_extract(df$Result, "\\((\\d+)-(\\d+)\\)") %>%
    str_replace_all("[()]", "") %>%
    str_split("-") %>%
    sapply(function(x) sum(as.integer(x)))
      df$Series_Pace <- as.numeric(df$Series_Pace)
      df$Series_eFGpct <- as.numeric(df$Series_eFGpct)
      df$`Series_TOVpct` <- as.numeric(df$Series_TOVpct)
      df$`Series_ORBpct` <- as.numeric(df$Series_ORBpct)
      df$Series_FTperFGA <- as.numeric(df$Series_FTperFGA)
      df$Series_ORtg <- as.numeric(df$Series_ORtg)
      df$Series_PTSperG <- as.numeric(df$Series_PTSperG)
  df$Year <- as.integer(str_extract(name, "\\d{4}"))
  df$Series <- str_extract(name, "^[^_]+")
  df$Team <- str_sub(df$Result, 1, 3)
  df$Team <- sapply(df$Team, function(team) team_name_mapping[team])
  df$`Series_Victory_Margin` <- str_extract(df$Result, "\\((\\d+)-(\\d+)\\)") %>%
      str_replace_all("[()]", "") %>%
      str_split("-") %>%
      sapply(function(x) as.integer(x[1]) - as.integer(x[2]))
  df$`Series_Net_Rating` <- c(df$Series_ORtg[1] - df$Series_ORtg[2], df$Series_ORtg[2] -                                   df$Series_ORtg[1])
  df$`Series_Win/Loss` <- c(1, 0)
  df$`Series_Abs_Net_Rating` <- abs(df$`Series_Net_Rating`)
  return(df)
  }) %>% 
setNames(names(Playoffs_FourFactors))

keep_columns_2_and_4 <- function(data_list) {
  lapply(data_list, function(df) df[, c(2, 4), drop = FALSE])
}
Playoffs_Advanced <- keep_columns_2_and_4(Playoffs_Advanced)

```

#### Joining regular season data to playoff series data

```{r, message=FALSE, warning=FALSE}
Playoffs <- list()

for (year in 1997:2024) {
  for (file in Playoff_series) {
    
    playoff_teams <- unique(Playoffs_FourFactors[[paste0(file, "_", year)]][["Team"]])
    
    season_data_filtered <- Seasons[[paste0("Season_", year)]] %>%
      filter(Team %in% playoff_teams)
    
    Playoffs[[paste0(file, "_", year)]] <- left_join(
      Playoffs_FourFactors[[paste0(file, "_", year)]],
      season_data_filtered,
      by = c("Team", "Year")
    )
  }
}
```

### Analysis

Here we will use regular season team data from basketball reference, with a particular emphasis on shooting data and Four Factors.

So the method is, for each playoff series, to go fetch the regular season data for the corresponding teams, and to make transformations on the regular season data so that we get the differentials between the teams' stats.

First, we create differential that measure the difference between Team A's offensive/defensive performance against the league and Team B's defensive/offensive performance against the league, and vice versa.

```{r}
team_stats <- c("ORtg", "FGMr", "FGAr", "FG%", "3PMr", "3PAr", "3P%", "2PMr", "2PAr", "2P%", "FTAr", "ORBr", "TRBr", "ASTr", "oppSTLr", "oppBLKr", "TOVr", "oppPFr", "Average_age", "Pace", "eFG%", "TOV%", "ORB%", "FT_per_FGA", "Attendance_per_game", "Average_FGA_distance", "2P%FGA", "0_3%FGA", "3_10%FGA", "10_16%FGA", "16_3P%FGA", "3P%FGA", "0_3FG%", "3_10FG%", "10_16FG%", "16_3PFG%", "2P%FGAst", "3P%FGAst", "Dunks%FGA", "Made_dunks", "Corner%3PA", "Corner3P%")
opponent_stats <- c("DRtg", "oppFGMr", "oppFGAr", "oppFG%", "opp3PMr", "opp3PAr", "opp3P%", "opp2PMr", "opp2PAr", "opp2P%", "oppFTAr", "oppORBr", "oppTRBr", "oppASTr", "STLr", "BLKr", "oppTOVr", "PFr", "Average_age", "Pace", "oppeFG%", "oppTOV%", "DRB%", "oppFT_per_FGA", "Attendance_per_game", "oppAverage_FGA_distance", "opp2P%FGA", "opp0_3%FGA", "opp3_10%FGA", "opp10_16%FGA", "opp16_3P%FGA", "opp3P%FGA", "opp0_3FG%", "opp3_10FG%", "opp10_16FG%", "opp16_3PFG%", "opp2P%FGAst", "opp3P%FGAst", "oppDunks%FGA", "oppMade_dunks", "oppCorner%3PA", "oppCorner3P%")

for (name in names(Playoffs)) {
  if (!is.null(Playoffs[[name]]) && nrow(Playoffs[[name]]) == 2) {
    
    df <- Playoffs[[name]]
    
    for (i in seq_along(team_stats)) {
      team_col <- team_stats[i]
      opp_col <- opponent_stats[i]
      new_col <- paste0("Diff_", team_col)
      
      if (team_col %in% names(df) && opp_col %in% names(df)) {

        df[[new_col]] <- c(
          df[[team_col]][1] - df[[opp_col]][2], 
          df[[team_col]][2] - df[[opp_col]][1]   
        )
      }
    }
    Playoffs[[name]] <- df
  }
}
```

Now that we have generated metrics that capture difference in overall team quality, difference in fundamentals and difference in shooting efficiency, we want to create a learning model to predict Series Offensive Rating as the target variable.

Creating dummy variables so that the series information is captured (Finals, Conference Finals, Round 2, Round 1).

```{r}
Playoffs_combined <- do.call(rbind, Playoffs) %>%
  mutate(
    Finals = ifelse(Series == "Finals", 1, 0),
    WCF = ifelse(Series == "WCF", 1, 0),
    ECF = ifelse(Series == "ECF", 1, 0),
    ECR2 = ifelse(Series == "ECR2", 1, 0),
    WCR2 = ifelse(Series == "WCR2", 1, 0),
    ECR1 = ifelse(Series == "ECR1", 1, 0),
    WCR1 = ifelse(Series == "WCR1", 1, 0)
  )
Playoffs_combined <- Playoffs_combined[-c(739, 740), ]
```

```{r}
Playoffs_Advanced <- mapply(function(advanced_df, index) {

  advanced_df$Team <- Playoffs_combined$Team[index]
  advanced_df$Year <- Playoffs_combined$Year[index]
  advanced_df$Series_Games <- Playoffs_combined$Series_Games[index]
  
  return(advanced_df)
}, Playoffs_Advanced, seq_along(Playoffs_Advanced), SIMPLIFY = FALSE)

Playoffs_Advanced <- lapply(names(Playoffs_Advanced), function(name) {
  df <- Playoffs_Advanced[[name]]
  colnames(df)[1] <- "Player"
  colnames(df)[2] <- "GP"
  df <- df[-1, ]
  df$Series_Games <- as.numeric(df$Series_Games)
  df$GP <- as.numeric(df$GP)
  df$`Games_missed` <- df$Series_Games - df$GP
 return(df)
 }) %>% 
setNames(names(Playoffs_Advanced))
```

Showing that the Four Factors explain almost all of ORtg in the regular season and playoffs.

```{r}
# Linear regression model
model <- lm(ORtg ~ `eFG%` + `TOV%` + `ORB%` + FT_per_FGA, data = Playoffs_combined)

# Display the summary of the model
summary(model)
```

```{r}
# Linear regression model
model <- lm(Series_ORtg ~ `Series_eFGpct` + `Series_TOVpct` + `Series_ORBpct` + Series_FTperFGA, data = Playoffs_combined)

# Display the summary of the model
summary(model)
```

Using regular season four factors to predict playoffs ORtg as a benchmark model.

```{r}
# Linear regression model
model <- lm(Series_ORtg ~ `eFG%` + `TOV%` + `ORB%` + FT_per_FGA, data = Playoffs_combined)

# Display the summary of the model
summary(model)

```

Better offensive teams tend to perform better offensively in the playoffs. However overall quality explains much less of playoff results. Firstly the free throw effect. But we also get a signal that there must be some matchup-related explanation.

Run a random forest model with ORtg as target variable. We take out all series outcomes and rendundant variables of the data set, so that only regular season data is used to predict Series_ORtg.

```{r}
Playoffs_combined_rf <- Playoffs_combined %>%
  select(-c(Result, Series_Pace, Series_eFGpct, Series_ORBpct, Series_TOVpct, Series_FTperFGA, Series_Abs_Net_Rating, Series_PTSperG, Series_Victory_Margin, Series_Net_Rating, `Series_Win/Loss`, Series_Abs_Net_Rating, Losses, Series, Series_Games))  %>%
  mutate(across(everything(), ~ replace_na(., 0)))

#Playoffs_combined_rf <- na.omit(Playoffs_combined_rf)

# Set a seed for reproducibility
set.seed(42)

# Split data into training and testing sets
split_index <- createDataPartition(Playoffs_combined_rf$Series_ORtg, p = 0.8, list = FALSE)
train_data <- Playoffs_combined_rf[split_index, ]
test_data <- Playoffs_combined_rf[-split_index, ]

# Define target and features for training
x_train <- train_data %>% select(-Series_ORtg)
y_train <- train_data$Series_ORtg

# Train the random forest model
rf_model <- randomForest(x_train, y_train, importance = TRUE, ntree = 500)

# Ensure the test data contains the same columns as training
x_test <- test_data[, colnames(x_train), drop = FALSE]
y_test <- test_data$Series_ORtg

# Make predictions
predictions <- predict(rf_model, x_test)

# Calculate RMSE
rmse <- sqrt(mean((predictions - y_test)^2))
cat("Root Mean Squared Error:", rmse, "\n")

# Display variable importance
print(importance(rf_model))
varImpPlot(rf_model, sort = TRUE, n.var = 12)

Playoffs_combined_rf$Predicted_ORtg_rf <- predict(rf_model, newdata = Playoffs_combined_rf)
Playoffs_combined <- Playoffs_combined %>%
  mutate(Predicted_ORtg_rf = Playoffs_combined_rf %>% pull(Predicted_ORtg_rf))

```

Let's fit a linear learning model to the data. First we try without the differentials to have a benchmark model from the regular season data.

```{r}
Playoffs_combined_lm_bm <- Playoffs_combined %>%
  select(-c(Result, Series_Pace, Series_eFGpct, Series_ORBpct, Series_TOVpct, Series_FTperFGA, Series_Abs_Net_Rating, Series_PTSperG, Series_Victory_Margin, Series_Net_Rating, `Series_Win/Loss`, Series_Abs_Net_Rating, Losses, Series, Arena, Team, 
"Diff_FGMr",                 "Diff_FGAr",                 "Diff_FG%",                 
"Diff_3PMr",                 "Diff_3PAr",                 "Diff_3P%",                 
"Diff_2PMr",                 "Diff_2PAr",                 "Diff_2P%",                 
"Diff_FTAr",                 "Diff_ORBr",                 "Diff_TRBr",                
"Diff_ASTr",                 "Diff_oppSTLr",              "Diff_oppBLKr",             
"Diff_TOVr",                 "Diff_oppPFr",               "Diff_Average_age",         
"Diff_Pace",                 "Diff_eFG%",                 "Diff_TOV%",                
"Diff_ORB%",                 "Diff_FT_per_FGA",           "Diff_Average_FGA_distance",
"Diff_2P%FGA",               "Diff_0_3%FGA",              "Diff_3_10%FGA",            
"Diff_10_16%FGA",            "Diff_16_3P%FGA",            "Diff_3P%FGA",              
"Diff_0_3FG%",               "Diff_3_10FG%",              "Diff_10_16FG%",            
"Diff_16_3PFG%",             "Diff_2P%FGAst",             "Diff_3P%FGAst",            
"Diff_Dunks%FGA",            "Diff_Made_dunks",           "Diff_Corner%3PA",          
"Diff_Corner3P%", Predicted_ORtg_rf, Series_Games))

linear_model_bm <- lm(Series_ORtg ~ ., data = Playoffs_combined_lm_bm)

# Summary of the model
summary(linear_model_bm)

# Diagnostics: Check residuals
par(mfrow = c(2, 2)) # Set layout for plots
plot(linear_model_bm)

# Predict using the model
Playoffs_combined$Predicted_ORtg_lm_bm <- predict(linear_model_bm, newdata = Playoffs_combined_lm_bm)
```

We see that we have gone from 0.36 R-squared (when using the Regular Season Four Factors) to 0.52 when adding per 100 possession, advanced and shooting stats for team and opponent. Now let's add in the differentials.

```{r}
Playoffs_combined_lm <- Playoffs_combined %>%
  select(-c(Result, Series_Pace, Series_eFGpct, Series_ORBpct, Series_TOVpct, Series_FTperFGA, Series_Abs_Net_Rating, Series_PTSperG, Series_Victory_Margin, Series_Net_Rating, `Series_Win/Loss`, Series_Abs_Net_Rating, Losses, Series, Arena, Team, Predicted_ORtg_rf, Predicted_ORtg_lm_bm, Series_Games))

linear_model <- lm(Series_ORtg ~ ., data = Playoffs_combined_lm)

# Summary of the model
summary(linear_model)

# Diagnostics: Check residuals
par(mfrow = c(2, 2)) # Set layout for plots
plot(linear_model)

# Predict using the model
Playoffs_combined$Predicted_ORtg_lm <- predict(linear_model, newdata = Playoffs_combined_lm)
```

Factoring the differentials increases the R-Squared to 0.57. If we look at the variables with high significance levels we get an interesting list.

2P%

oppFGMr

Wins

0_3FG%

3_10FG%

Dunks%FGA

Corner%3PA

Made_heaves

opp0_3%FGA

opp3_10%FGA

opp10_16%FGA

opp16_3P%FGA

oppDunks%FGA

Diff_2P%

Diff_TRBr

Diff_oppBLKr

Diff_eFG%

Diff_2P%FGA

Diff_3P%FGA

Diff_Dunks%FGA

Diff_Corner%3PA

Considering we are not taking injuries into account, a R-Squared of 0.57 with very high significance for our model seems pretty strong. We have also extracted a list of factors that provide interesting interpretations. An expansion of the Four Factors idea to include the transition from Regular Season to Playoffs.

```{r}
Predictions <- Playoffs_combined %>%
  select(Team, Year, Series, Result, Series_ORtg, Predicted_ORtg_rf, Predicted_ORtg_lm_bm, Predicted_ORtg_lm)
```

What we would have to do next is download the team stats tables from each series as well as a BPM or other player evaluation metric, and calculate the amount of "BPM lost", using the number of games played in the series.

If we download a BPM dataset for the teams we could join it to Playoffs_advanced and fill in the Games Played by zero for those who are not in both data frames.

We must download the html pages of the teams that made the playoffs in each season, and then make a loop to extract the Advanced stats for the players (which contains BPM), then join that to Playoffs_advanced by filling in missing players with zero in GP.

So next steps?

-change differentials to just include the specific opponent's data without calculating differentials, to see if this improves the predictive performance

-download NBA.com datasets (possible through webscraping?)

--\>playtype

--\>lineups (eg Net Rating best lineups minimum x possessions, or perhaps just one table for each season with the 100 best lineups in the NBA or so and then find a way to join this by team name)

-Player injuries with bball reference BPM (download a table for each playoff team for each season)
